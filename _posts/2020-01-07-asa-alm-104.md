---
layout: post
title:  "Automated deployment for an Azure Stream Analytics job - ASA-ALM-104"
date:   2020-01-07 10:00:00 -0700
categories: ALM Azure ASA DevOps
---

# Release pipeline for an Azure Stream Analytics job - ASA-ALM-104

This article is part of a series on enabling modern ALM practices for an Azure Stream Analytics project:

- Part 1 : [100 - The story of 2 pipelines](https://www.eiden.ca/asa-alm-100/)
- Part 2 : [101 - Local developer experience](https://www.eiden.ca/asa-alm-101/)
- Part 3 : [102 - Provisioning scripts and live job](https://www.eiden.ca/asa-alm-102/)
- Part 4 : [103 - Continuous build](https://www.eiden.ca/asa-alm-103/)
- **Part 5** : [104 - Automated deployment](https://www.eiden.ca/asa-alm-104/)
- Part 6 : Unit testing - to be written
- Part 7 : Integration testing - to be written

## Context

Now that we have a **continuous build pipeline** (see [103](https://www.eiden.ca/asa-alm-103/)) it should be easy to set up automated deployment using a release pipeline of Azure DevOps. 

For our little project we will just deploy to one live environment: **staging**. That said, and like we discussed [earlier](https://www.eiden.ca/asa-alm-100/), getting that wiring right will allow us to add [as many environments](https://docs.microsoft.com/en-us/azure/devops/pipelines/release/define-multistage-release-process?view=azure-devops) as we'd want (staging, integration, UAT, pre-prod, prod...).

![Illustration of our dev pipeline](https://github.com/Fleid/fleid.github.io/blob/master/_posts/201912_asa_alm101/asa_alm103.png?raw=true)

## Constraints

Deploying an ASA job via ARM template will require the release pipeline to receive the following inputs:

- Target **resource group** and **ASA job name**. A good thing that we can rename our job at deployment to add its environment and potentially a version number in a suffix
- **Location**, as in [Azure locations](https://azure.microsoft.com/en-us/global-infrastructure/locations/), or else the deployment will end being in the default location of the template. In real time scenarios we need to be mindful of geography, so let's choose wisely (or not for training purposes)
- **OutputStartMode**, an attribute specific to ASA, covered [in the doc](https://docs.microsoft.com/en-us/azure/stream-analytics/start-job). I haven't had the chance to play much with it and see how to leverage it to be smarter about restarts. Right now I default it to `LastOutputEventTime` which means "when last stopped" (of course the job needs to have run at least once for that to be available, run it manually once if necessary)
- If [for the build](https://www.eiden.ca/asa-alm-103/) we avoided loading the real credentials in our ARM template, now we will have too. Since we're doing things the right way, we'll store them in [KeyVault](https://azure.microsoft.com/en-us/services/key-vault/), and get them only when needed. We'll see how to do that below
- And of course, our **ARM template files** themselves, hot out of our build pipeline

![Focus on the release pipeline](https://github.com/Fleid/fleid.github.io/blob/master/_posts/201912_asa_alm101/asa_alm104_goal.png?raw=true)

## Infrastructure

### KeyVault

### Variable Groups

## Release pipeline

### Steps

### deploy.ps1

## Success

A warning on CI/CD setups and 24/7 compute resources such as an ASA job: pushing code to the origin repository will re-start them. So remember to turn them back off, or unplug the pipeline if need be, or better - script it.

## Next steps

- ~~Part 1~~ : [100 - The story of 2 pipelines](https://www.eiden.ca/asa-alm-100/)
- ~~Part 2~~ : [101 - Local developer experience](https://www.eiden.ca/asa-alm-101/)
- ~~Part 3~~ : [102 - Provisioning scripts and live job](https://www.eiden.ca/asa-alm-102/)
- ~~Part 4~~ : [103 - Continuous build](https://www.eiden.ca/asa-alm-103/)
- ~~Part 5~~ : [104 - Automated deployment](https://www.eiden.ca/asa-alm-104/)
- Part 6 : Unit testing - to be written
- Part 7 : Integration testing - to be written
